<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.7.2/css/all.css"
      integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="css/style.css" />
    <title>PDF Viewer</title>
</head>
<body>

	<div class="top-bar">
      <button class="btn" id="prev-page">
        <i class="fas fa-arrow-circle-left"></i> Prev Page
      </button>
      <button class="btn" id="next-page">
        Next Page <i class="fas fa-arrow-circle-right"></i>
      </button>
      <button class="btn" id="incScale">
        +
      </button>
      <button class="btn" id="decScale">
        -
      </button>
      <span class="page-info">
        Page <span id="page-num"></span> of <span id="page-count"></span>
      </span>
    </div>

    <canvas id="pdf-render"></canvas>

	 <script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>

	<script>



		// ---------------------- pdfviewer.js --------------------------
		// todo, no idea how to export it into a seperate file

		const urlApiServer = 'http://localhost:8080/';
		const serveSelectedPdf_endpoint = urlApiServer + 'serveSelectedPdf';
		const setPageNum_template = urlApiServer + 'setPageNum';
		const url = serveSelectedPdf_endpoint;

		let pdfDoc = null,
		    pageNum = 1,
		    pageIsRendering = false,
		    pageNumIsPending = null;

		let scale = 4,
		    canvas = document.querySelector('#pdf-render'),
		    ctx = canvas.getContext('2d');


		// Render the page
		const renderPage = num => {
		    pageIsRendering = true;

				console.log(num);
		    // Get page
		    pdfDoc.getPage(num).then(page => {
		        // Set scale
		        const viewport = page.getViewport({ scale });
		        canvas.height = viewport.height;
		        canvas.width = viewport.width;

		        const renderCtx = {
		            canvasContext: ctx,
		            viewport
		        };

		        page.render(renderCtx).promise.then(() => {
		            pageIsRendering = false;

		            if (pageNumIsPending !== null) {
		                renderPage(pageNumIsPending);
		                pageNumIsPending = null;
		            }
		        });

		        // Output current page
		        document.querySelector('#page-num').textContent = num;
		    });
		};

		// Check for pages rendering
		const queueRenderPage = num => {
		    if (pageIsRendering) {
		        pageNumIsPending = num;
		    } else {
		        renderPage(num);
		    }
		};

		// Show Prev Page
		const showPrevPage = () => {
		    if (pageNum <= 1) {
		        return;
		    }
		    pageNum--;
		    // setPageNum(pageNum);
		    queueRenderPage(pageNum);
		};

		// Show Next Page
		const showNextPage = () => {
		    if (pageNum >= pdfDoc.numPages) {
		        return;
		    }
		    pageNum++;
		    setPageNum(pageNum);
		    queueRenderPage(pageNum);
		};

		const showPage = (num) => {
		    if (pageNum >= pdfDoc.numPages) {
		        return;
		    }
		    queueRenderPage(num);
		}

		// scale func for button
		const incScalePage = () => {
		    scale = scale + 0.5;
		    renderPage(pageNum);
		    console.log('hier')
		}

		// scale func for button
		const decScalePage = () => {
		    scale = scale - 0.5;
		    renderPage(pageNum);
		    console.log('hier')
		}


		// Get Document
		    pdfjsLib
		        .getDocument(url)
		        .promise.then(pdfDoc_ => {
		        pdfDoc = pdfDoc_;

		        document.querySelector('#page-count').textContent = pdfDoc.numPages;

		        renderPage(pageNum);
		    })
		        .catch(err => {
		            // Display error
		            const div = document.createElement('div');
		            div.className = 'error';
		            div.appendChild(document.createTextNode(err.message));
		            document.querySelector('body').insertBefore(div, canvas);
		            // Remove top bar
		            document.querySelector('.top-bar').style.display = 'none';
		        });

		// Button Events
		// document.querySelector('#prev-page').addEventListener('click', showPrevPage);
		// document.querySelector('#next-page').addEventListener('click', showNextPage);
		// document.querySelector('#incScale').addEventListener('click', incScalePage);
		// document.querySelector('#decScale').addEventListener('click', decScalePage);


		function setPageNum(num) {
		    console.log("api joa");
		    requestPost('pageNum=' + num, setPageNum_template);
		}

		function requestPost(postSyntax, url) {
		    const xhr = new XMLHttpRequest();
		    xhr.onload = function () {
		        console.log(this.responseText);
		    }
		    xhr.open('POST', url);
		    xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
		    console.log('before send: ' + postSyntax);
		    xhr.send(postSyntax);
		}

		// ---------------------- end of pdfviewwer.js ------------------------

		// ------------------ Websocket connection --------------------

    var ws = new WebSocket('ws://localhost:40510');

    ws.onopen = function () {
        console.log('websocket is connected ...')
        ws.send('connected')
    }

    ws.onmessage = function (ev) {
        console.log(ev.data);
				showPage(ev.data);
    }

		// ---------------------- end of ws ------------------------

	</script>
</body>
</html>
